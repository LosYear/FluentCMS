<?php	require_once("plugins/pages/lang.php");	require_once("plugins/pages/classes/class.upload.php");		/* =========================== FUNCTIONS ========================================== */	function sidebar(){		global $lang;		echo "<a href=\"index.php?plugin_control=teams\">{$lang['profiles']}</a>";			}	function teams_echo(){	    global $db_host, $db_user, $db_pass, $db, $lang;		if (!mysql_connect($db_host, $db_user, $db_pass))		  die(mysql_error());		mysql_select_db($db);		$sql = "SELECT id,name,photo FROM `pages`;";		$result = mysql_query($sql) or die($lang['something_went_wrong']);		echo "<h1>{$lang['profiles']}</h1>";				for($i = 0; $i < mysql_num_rows($result); $i++){		    $r = mysql_fetch_array($result);		    $id = $r['id'];		    $name = $r['name'];		    $photo = $r['photo'];		    if (!file_exists($_SERVER['DOCUMENT_ROOT'] . "/plugins/pages/data/{$photo}_mini.png")){		        $photo = 'unknown';		    }		    echo "<div id=\"team\"><img src=\"http://{$_SERVER['SERVER_NAME']}/plugins/pages/data/{$photo}_mini.png\"><a href=\"index.php?plugin_control=profile&id=$id\">$name</a></div><hr/>";		}	}	function atPanelEcho(){		echo "<a href=\"index.php?plugin_control=profile\"><img title=\"Личная страница\" src=\"plugins/pages/imgs/profile.png\"></a> ";	}		function profileEcho(){		global $db_host, $db_user, $db_pass, $db, $lang;		if (!mysql_connect($db_host, $db_user, $db_pass))		  die(mysql_error());		mysql_select_db($db);		$sql = "SELECT * FROM `pages` WHERE id='{$_SESSION['id']}' LIMIT 1;";		$result = mysql_query($sql);		if (mysql_num_rows($result) == 0){			echo "<center><a href=\"index.php?plugin_control=add_profile\"><h1>{$lang['profile_create_new']}</h1></a></center>";		}		else {			global $db_host, $db_user, $db_pass, $db, $lang;		    if (!mysql_connect($db_host, $db_user, $db_pass))		      die(mysql_error());		    mysql_select_db($db);		    if(isset($_REQUEST['id'])){		        $id = $_REQUEST['id'];		    }		    else{		        $id = $_SESSION['id'];		    }		    $sql = "SELECT * FROM `pages` WHERE id={$id}";		    $result = mysql_query($sql) or die($lang['something_went_wrong']);		    $result = mysql_fetch_array($result);		    echo "<h1>{$result['name']}</h1>";		    echo "<p><img src=\"http://{$_SERVER['SERVER_NAME']}/plugins/pages/data/{$id}_full.png\"></p>"; /* Photo */		    echo "<p>{$result['about_team']}</p>";		    echo "<p>{$lang['teacher']} {$result['teacher']}</p>"; 		    echo "<p>{$lang['school']} {$result['school']}</p>";		    if(!isset($_REQUEST['id'])){		        echo "<a href=\"index.php?plugin_control=profile_edit\">{$lang['profile_edit']}</a>";		    }		}	}		function addProfile(){	    global $lang;		echo "<h1>{$lang['profile_create']}</h1>";		echo "<form enctype=\"multipart/form-data\" action=\"index.php?plugin_control=profile_create\" method=\"post\">";			echo "<label for=\"name\">{$lang['team_name']}</label><br/><input type=\"text\" name=\"name\"/><br/>";			echo "<label for=\"teacher\">{$lang['teacher']}</label><br/><input type=\"text\" name=\"teacher\"/><br/>";			echo "<label for=\"school\">{$lang['school']}</label><br/><input type=\"text\" name=\"school\"/><br/>";			echo "<label for=\"about_team\">{$lang['about_team']}</label><br/><textarea rows=\"5\" cols=\"30\" name=\"about_team\"></textarea><br/>";			echo "<label for=\"photo\">{$lang['photo']}</label><br/><input type=\"file\" name=\"photo\"><br/>";			echo "<input type=\"submit\" value=\"{$lang['create']}\">";		echo "</form>";				}		function profile_create(){	    global $db_host, $db_user, $db_pass, $db, $lang;		if (!mysql_connect($db_host, $db_user, $db_pass))		  die(mysql_error());		mysql_select_db($db);		$name = $_REQUEST['name'];		$teacher = $_REQUEST['teacher'];		$school = $_REQUEST['school'];		$team = $_REQUEST['about_team'];		$photo = $_REQUEST['photo'];				$hphoto = new upload($_FILES['photo']);		if ( $hphoto->uploaded ){		    $hphoto->file_name_body_pre = "{$_SESSION['id']}_";		    $hphoto->file_new_name_body = "full";		    $hphoto->file_overwrite = true;		    $hphoto->image_resize = true;		    $hphoto->image_ratio = true;		    $hphoto->image_y = 300;		    $hphoto->image_x = 300;		    $path = $_SERVER['DOCUMENT_ROOT'] . "/plugins/pages/data/";		    $hphoto->image_convert = 'png';		    $hphoto->process($path);            if (!$hphoto->processed) {              echo $lang['something_went_wrong'] . $hphoto->error;            }                        $hphoto->file_name_body_pre = "{$_SESSION['id']}_";            $hphoto->file_new_name_body = "mini";		    $hphoto->file_overwrite = true;		    $hphoto->image_resize = true;		    $hphoto->image_ratio = true;		    $hphoto->image_y = 100;		    $hphoto->image_x = 100;		    $hphoto->image_convert = 'png';		    $hphoto->process($path);		    if (!$hphoto->processed) {              echo $lang['something_went_wrong'] . $hphoto->error;            }		    $hphoto->file_name_body_pre = "{$_SESSION['id']}_";		    $hphoto->file_new_name_body = "origin";		    $hphoto->file_overwrite = true;		    $hphoto->image_resize = false;		    $hphoto->image_ratio = false;		    $hphoto->image_convert = 'png';		    $path = $_SERVER['DOCUMENT_ROOT'] . "/plugins/pages/data/";		    $hphoto->process($path);            if (!$hphoto->processed) {              echo $lang['something_went_wrong'] . $hphoto->error;            }                        $hphoto->clean();            		}		else {		    die($lang['something_went_wrong']);		}				$sql = "INSERT INTO `pages` (                `id` ,                `type` ,                `name` ,                `teacher` ,                `school` ,                `about_team` ,                `photo`                 )                VALUES (                '{$_SESSION['id']}', '3', '$name', '$teacher', '$school', '$team', '{$_SESSION['id']}'                );";		mysql_query($sql) or die($lang['something_went_wrong']);		echo $lang['profile_created'];	    	}		function profile_edit(){	        global $db_host, $db_user, $db_pass, $db, $lang;		    if (!mysql_connect($db_host, $db_user, $db_pass))		      die(mysql_error());		    mysql_select_db($db);		    $sql = "SELECT * FROM `pages` WHERE id={$_SESSION['id']}";		    $result = mysql_query($sql) or die($lang['something_went_wrong']);		    $result = mysql_fetch_array($result);		    echo "<form enctype=\"multipart/form-data\" action=\"index.php?plugin_control=profile_edit_submit\" method=\"post\">";			    echo "<label for=\"name\">{$lang['team_name']}</label><br/><input type=\"text\" name=\"name\" value=\"{$result['name']}\" /><br/>";			    echo "<label for=\"teacher\">{$lang['teacher']}</label><br/><input type=\"text\" name=\"teacher\" value=\"{$result['teacher']}\" /><br/>";			    echo "<label for=\"school\">{$lang['school']}</label><br/><input type=\"text\" name=\"school\" value=\"{$result['school']}\" /><br/>";			    echo "<label for=\"about_team\">{$lang['about_team']}</label><br/><textarea rows=\"5\" cols=\"30\" name=\"about_team\">{$result['about_team']}</textarea><br/>";			    echo "<label for=\"photo\">{$lang['photo']}</label><br/><input type=\"file\" name=\"photo\" value=\"{$result['photo']}\" ><br/>";			    echo "<input type=\"submit\" value=\"{$lang['edit']}\">";		    echo "</form>";				    	}		function profile_edit_submit(){	    global $db_host, $db_user, $db_pass, $db, $lang;		if (!mysql_connect($db_host, $db_user, $db_pass))		  die(mysql_error());		mysql_select_db($db);		$name = $_REQUEST['name'];		$teacher = $_REQUEST['teacher'];		$school = $_REQUEST['school'];		$team = $_REQUEST['about_team'];		$photo = $_REQUEST['photo'];		$sql = "UPDATE `pages` SET `name`='{$name}', `teacher`='{$teacher}', `school`='{$school}', `about_team`='{$team}', `photo`='{$photo}'			WHERE `id`={$_SESSION['id']} LIMIT 1;";		mysql_query($sql) or die($lang['something_went_wrong']);		echo $lang['profile_edited'];	  	    	}		$events->register("fl_sidebar_print","sidebar");	$events->register("login_panel_echo","atPanelEcho");	$events->register("profile","profileEcho");	$events->register("add_profile","addProfile");	$events->register("profile_create","profile_create");	$events->register("profile_edit","profile_edit");	$events->register("profile_edit_submit","profile_edit_submit");	$events->register("teams","teams_echo");?>